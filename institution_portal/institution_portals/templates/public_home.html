<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Institution Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    
  >
</head>
<body>

<!-- Top navbar with Sign in on right -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{{ url_for('public_home') }}">
      Institution Portal
    </a>
    <div class="ms-auto">
      <a class="btn btn-light" href="{{ url_for('login') }}">Sign in</a>
    </div>
  </div>
</nav>

<!-- Spacer so content is not hidden under fixed navbar -->
<div style="height: 70px;"></div>

<div class="container mt-4">

  <h3 class="mt-2">Attendance</h3>
  <p>Students can quickly view their overall attendance using registration number.</p>

  <hr class="my-4">
  <h2 class="mb-3 text-center">Upcoming Club Events</h2>

  {% if events %}
    {% for e in events %}
    <div class="row mb-4">
      <div class="col-lg-10 col-xl-8 mx-auto">
        <div class="card shadow-sm">
          {% if e.image_name %}
          <img
            src="{{ url_for('event_image', filename=e.image_name) }}"
            class="card-img-top"
            style="width:100%; height:auto;"
          >
          {% endif %}
          <div class="card-body">
            <h5 class="card-title mb-1">{{ e.title }}</h5>
            <p class="card-subtitle text-muted mb-2">
              {% if e.date %}{{ e.date }}{% endif %}
              {% if e.venue %} Â· {{ e.venue }}{% endif %}
            </p>
            {% if e.description %}
            <p class="card-text" style="font-size:0.9rem;">{{ e.description }}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <p class="text-center">No upcoming events.</p>
  {% endif %}

</div>

<!-- Floating attendance button -->
<div id="att-toggle" style="
  position: fixed; bottom: 20px; right: 90px;
  padding: 8px 14px; border-radius: 20px;
  background-color: #198754; color: #fff;
  cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 1050; font-size: 14px; font-weight: 600;
">
  Check Attendance
</div>

<!-- Attendance slide-up panel -->
<div id="att-panel" style="
  position: fixed; bottom: 80px; right: 20px;
  width: 320px; max-height: 260px;
  background: #fff; border: 1px solid #ccc; border-radius: 8px;
  display: none; flex-direction: column;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1050; padding: 12px;
">
  <h6 style="margin-bottom:8px;">ðŸ“Š Check Attendance</h6>
  <div class="mb-2">
    <label class="form-label mb-1">Registration Number</label>
    <input type="text" id="att_reg_no" class="form-control form-control-sm"
           placeholder="e.g., 21CS001">
  </div>
  <button class="btn btn-success btn-sm w-100 mb-2" id="att_check_btn">
    Check
  </button>
  <div id="att_result" style="display:none; font-size:0.9rem;">
    <div><strong id="att_name"></strong> (<span id="att_reg"></span>)</div>
    <div>Attendance: <strong id="att_pct"></strong></div>
    <div>Total: <span id="att_total"></span>,
        Attended: <span id="att_attended"></span>,
        Missed: <span id="att_missed"></span>
    </div>
  </div>
  <div id="att_error" class="text-danger" style="display:none; font-size:0.9rem;"></div>
</div>

<!-- Floating chat button -->
<div id="chat-toggle" style="
  position: fixed; bottom: 20px; right: 20px;
  width: 60px; height: 60px; border-radius: 50%;
  background-color: #0d6efd; color: #fff;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 1050;
">
  AI
</div>

<!-- Chat window -->
<div id="chat-window" style="
  position: fixed; bottom: 90px; right: 20px;
  width: 320px; max-height: 420px;
  background: #fff; border: 1px solid #ccc; border-radius: 8px;
  display: none; flex-direction: column;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1050;
">
  <div style="padding: 8px 12px; background:#0d6efd; color:#fff;
              border-top-left-radius:8px;border-top-right-radius:8px;">
    Institution Assistant
  </div>
  <div id="chat-messages" style="padding: 8px 12px; overflow-y:auto; flex:1; font-size: 0.9rem;">
    <div><strong>Assistant:</strong> Hi! Ask me about the institution, departments, or exams.</div>
  </div>
  <form id="chat-form" style="display:flex; border-top:1px solid #ddd;">
    <input id="chat-input" type="text" class="form-control"
           placeholder="Type your question..." autocomplete="off"
           style="border:0; border-radius:0;">
    <button class="btn btn-primary" type="submit">Send</button>
  </form>
</div>

<script>
  const ATT_API_URL = '/api/att';

  const attToggle = document.getElementById('att-toggle');
  const attPanel  = document.getElementById('att-panel');
  const attInput  = document.getElementById('att_reg_no');
  const attBtn    = document.getElementById('att_check_btn');
  const attResult = document.getElementById('att_result');
  const attError  = document.getElementById('att_error');

  attToggle.addEventListener('click', () => {
    const visible = attPanel.style.display === 'flex';
    attPanel.style.display = visible ? 'none' : 'flex';
    if (!visible) {
      attResult.style.display = 'none';
      attError.style.display = 'none';
      attInput.value = '';
      attInput.focus();
    }
  });

  attBtn.addEventListener('click', checkAttSmall);
  attInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') checkAttSmall();
  });

  async function checkAttSmall() {
    const regNo = attInput.value.trim();
    if (!regNo) {
      showAttError('Please enter a registration number');
      return;
    }
    attResult.style.display = 'none';
    attError.style.display = 'none';

    try {
      const resp = await fetch(`${ATT_API_URL}/attendance/${encodeURIComponent(regNo)}`);
      const data = await resp.json();
      if (!resp.ok) {
        showAttError(data.error || 'Student not found');
        return;
      }
      displayAttResult(data);
    } catch (e) {
      showAttError('Error fetching attendance. Try again.');
    }
  }

  function displayAttResult(data) {
    document.getElementById('att_name').textContent = data.student_name;
    document.getElementById('att_reg').textContent = data.reg_no;
    document.getElementById('att_pct').textContent = data.attendance_percentage + '%';
    document.getElementById('att_total').textContent = data.total_classes;
    document.getElementById('att_attended').textContent = data.attended_classes;
    document.getElementById('att_missed').textContent =
      data.total_classes - data.attended_classes;

    attError.style.display = 'none';
    attResult.style.display = 'block';
  }

  function showAttError(msg) {
    attResult.style.display = 'none';
    attError.textContent = msg;
    attError.style.display = 'block';
  }

  const chatToggle = document.getElementById("chat-toggle");
  const chatWindow = document.getElementById("chat-window");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");

  chatToggle.addEventListener("click", () => {
    const visible = chatWindow.style.display === "flex";
    chatWindow.style.display = visible ? "none" : "flex";
  });

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;

    const userHtml = `<div><strong>You:</strong> ${text}</div>`;
    chatMessages.insertAdjacentHTML("beforeend", userHtml);
    chatInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      const resp = await fetch("/api/assistant/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: text})
      });

      const data = await resp.json();
      const reply = data.reply || "Sorry, I could not understand that.";
      const botHtml = `<div><strong>Assistant:</strong> ${reply}</div>`;
      chatMessages.insertAdjacentHTML("beforeend", botHtml);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      const errHtml = `<div><strong>Assistant:</strong> There was an error talking to the server.</div>`;
      chatMessages.insertAdjacentHTML("beforeend", errHtml);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  });
</script>

</body>
</html>

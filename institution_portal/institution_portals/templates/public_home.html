<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Institution Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body>

<!-- Top navbar with Sign in on right -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{{ url_for('public_home') }}">
      Institution Portal
    </a>
    <div class="ms-auto">
      <a class="btn btn-light" href="{{ url_for('login') }}">Sign in</a>
    </div>
  </div>
</nav>

<!-- Spacer so content is not hidden under fixed navbar -->
<div style="height: 70px;"></div>

<div class="container mt-4">

  <hr class="my-4">
  <h2 class="mb-3 text-center">Upcoming Club Events</h2>

  {% if events %}
    {% for e in events %}
    <div class="row mb-4">
      <div class="col-lg-10 col-xl-8 mx-auto">
        <div class="card shadow-sm">
          {% if e.image_name %}
          <img
            src="{{ url_for('event_image', filename=e.image_name) }}"
            class="card-img-top"
            style="width:100%; height:auto;"
          >
          {% endif %}
          <div class="card-body">
            <h5 class="card-title mb-1">{{ e.title }}</h5>
            <p class="card-subtitle text-muted mb-2">
              {% if e.date %}{{ e.date }}{% endif %}
              {% if e.venue %} Â· {{ e.venue }}{% endif %}
            </p>
            {% if e.description %}
            <p class="card-text" style="font-size:0.9rem;">{{ e.description }}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <p class="text-center">No upcoming events.</p>
  {% endif %}

</div>

<!-- Floating chat button -->
<div id="chat-toggle" style="
  position: fixed; bottom: 20px; right: 20px;
  width: 60px; height: 60px; border-radius: 50%;
  background-color: #0d6efd; color: #fff;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 1050;
">
  AI
</div>

<!-- Chat window -->
<div id="chat-window" style="
  position: fixed; bottom: 90px; right: 20px;
  width: 320px; max-height: 420px;
  background: #fff; border: 1px solid #ccc; border-radius: 8px;
  display: none; flex-direction: column;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1050;
">
  <div style="padding: 8px 12px; background:#0d6efd; color:#fff;
              border-top-left-radius:8px;border-top-right-radius:8px;">
    Institution Assistant
  </div>
  <div id="chat-messages" style="padding: 8px 12px; overflow-y:auto; flex:1; font-size: 0.9rem;">
    <div><strong>Assistant:</strong> Hi! Ask me about the institution, departments, or exams.</div>
  </div>
  <form id="chat-form" style="display:flex; border-top:1px solid #ddd;">
    <input id="chat-input" type="text" class="form-control"
           placeholder="Type your question..." autocomplete="off"
           style="border:0; border-radius:0;">
    <button class="btn btn-primary" type="submit">Send</button>
  </form>
</div>

<script>
  const chatToggle = document.getElementById("chat-toggle");
  const chatWindow = document.getElementById("chat-window");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");

  chatToggle.addEventListener("click", () => {
    const visible = chatWindow.style.display === "flex";
    chatWindow.style.display = visible ? "none" : "flex";
  });

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;

    const userHtml = `<div><strong>You:</strong> ${text}</div>`;
    chatMessages.insertAdjacentHTML("beforeend", userHtml);
    chatInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      const resp = await fetch("/api/assistant/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: text})
      });

      const data = await resp.json();
      const reply = data.reply || "Sorry, I could not understand that.";
      const botHtml = `<div><strong>Assistant:</strong> ${reply}</div>`;
      chatMessages.insertAdjacentHTML("beforeend", botHtml);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (err) {
      const errHtml = `<div><strong>Assistant:</strong> There was an error talking to the server.</div>`;
      chatMessages.insertAdjacentHTML("beforeend", errHtml);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  });
</script>

</body>
</html>

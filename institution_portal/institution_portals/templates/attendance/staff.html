{% extends "base.html" %}
{% block title %}Mark Attendance{% endblock %}

{% block sidebar %}
<h3>Staff Menu</h3>
<a href="{{ url_for('staff_home') }}">Dashboard</a>
<a href="{{ url_for('staff_my_courses') }}">My Courses</a>
<a href="{{ url_for('staff_attendance') }}">Attendance</a>
<a href="{{ url_for('staff_exam_schedule') }}">Exam Schedule</a>
{% endblock %}

{% block content %}
<div style="
  max-width:900px;
  background:white;
  padding:24px;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
">
  <h2 style="color:#28a745;margin-bottom:20px;">üìù Mark Attendance</h2>

  <div class="form-group" style="margin-bottom:16px;">
    <label>Select Class:</label>
    <select id="class_id" class="form-control">
      <option value="">-- Select Class --</option>
    </select>
  </div>

  <div class="form-group" style="margin-bottom:16px;">
    <label>Subject Name:</label>
    <input type="text" id="subject_name" class="form-control" placeholder="e.g., Mathematics">
  </div>

  <div class="form-group" style="margin-bottom:16px;">
    <label>Period Number:</label>
    <input type="number" id="period_number" class="form-control" placeholder="1, 2, 3..." min="1">
  </div>

  <div class="form-group" style="margin-bottom:16px;">
    <label>Date:</label>
    <input type="date" id="period_date" class="form-control">
  </div>

  <button class="btn btn-success" type="button" onclick="loadStudents()">Load Students</button>

  <div id="students_list" style="margin-top:24px;"></div>

  <button class="btn btn-success w-100 mt-3" type="button" onclick="submitAttendance()">Submit Attendance</button>

  <div id="result" class="mt-3"></div>
</div>

<script>
  const API_URL = '/api/att';
  let currentPeriodId = null;

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('period_date').valueAsDate = new Date();
    loadClasses();
  });

  // Load classes created by admin
  async function loadClasses() {
    try {
      const response = await fetch(`${API_URL}/classes`);
      const classes = await response.json();
      const select = document.getElementById('class_id');
      classes.forEach(c => {
        select.innerHTML += `<option value="${c.class_id}">${c.class_name} - ${c.department}</option>`;
      });
    } catch (err) {
      alert('Error loading classes: ' + err.message);
    }
  }

  // Load students for attendance
  async function loadStudents() {
    const classId = document.getElementById('class_id').value;
    const subjectName = document.getElementById('subject_name').value.trim();
    const periodNumber = document.getElementById('period_number').value;
    const periodDate = document.getElementById('period_date').value;

    if (!classId || !subjectName || !periodNumber || !periodDate) {
      alert('Please fill all fields!');
      return;
    }

    try {
      // Create period
      const periodResponse = await fetch(`${API_URL}/periods`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          class_id: parseInt(classId),
          subject_name: subjectName,
          period_number: parseInt(periodNumber),
          period_date: periodDate
        })
      });
      const periodData = await periodResponse.json();
      currentPeriodId = periodData.period_id;

      // Load students in that class
      // Load students (staff endpoint)
        const studentsResponse = await fetch(`${API_URL}/students_staff?class_id=${classId}`);
        const students = await studentsResponse.json();


      let html = '<h4>Mark Attendance:</h4>';
      students.forEach(student => {
        html += `
          <div class="d-flex justify-content-between align-items-center border rounded p-2 my-1">
            <span><strong>${student.reg_no}</strong> - ${student.student_name}</span>
            <label class="mb-0">
              <input type="checkbox" class="attendance-checkbox"
                     data-regno="${student.reg_no}" checked>
              Present
            </label>
          </div>
        `;
      });
      document.getElementById('students_list').innerHTML = html;
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  // Submit attendance
  async function submitAttendance() {
    if (!currentPeriodId) {
      alert('Please load students first!');
      return;
    }

    const checkboxes = document.querySelectorAll('.attendance-checkbox');
    const attendance = [];

    checkboxes.forEach(checkbox => {
      attendance.push({
        reg_no: checkbox.dataset.regno,
        is_present: checkbox.checked ? 1 : 0
      });
    });

    try {
      const response = await fetch(`${API_URL}/attendance`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          period_id: currentPeriodId,
          attendance: attendance
        })
      });
      const result = await response.json();
      document.getElementById('result').innerHTML =
        `<div class="alert alert-success mb-0">‚úÖ ${result.message}</div>`;
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }
</script>
{% endblock %}

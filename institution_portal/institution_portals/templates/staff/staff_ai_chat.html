{% extends "base.html" %}
{% block title %}AI Assistant — Staff{% endblock %}

{% block sidebar %}
<h3>Staff Menu</h3>
<a href="{{ url_for('staff_home') }}">Dashboard</a>
<a href="{{ url_for('staff_my_courses') }}">My Courses</a>
<a href="{{ url_for('staff_attendance') }}">Attendance</a>
<a href="{{ url_for('staff_exam_schedule') }}">Exam Schedule</a>
<a href="{{ url_for('staff_ai_chat') }}">AI Assistant</a>
{% endblock %}

{% block content %}
<div style="max-width:800px;margin:0 auto;">
  <div class="d-flex align-items-center mb-3">
    <div style="width:40px;height:40px;border-radius:50%;background:#0d6efd;
                display:flex;align-items:center;justify-content:center;
                color:#fff;font-weight:700;margin-right:10px;">
      AI
    </div>
    <div>
      <h4 class="mb-0">Staff AI Assistant</h4>
      <small class="text-muted">Ask about courses, exams, departments, or portal usage.</small>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body" style="height:460px;display:flex;flex-direction:column;">
      <div id="staff-chat-messages"
           style="flex:1;overflow-y:auto;padding:8px;background:#f8f9fa;border-radius:6px;">
        <div class="d-flex mb-2">
          <div class="badge bg-primary me-2">Assistant</div>
          <div class="p-2 rounded-3 bg-white border" style="max-width:85%;">
            Hi! Ask anything related to your classes, exams, or departments.
          </div>
        </div>
      </div>

      <form id="staff-chat-form" class="mt-3">
        <div class="input-group">
          <input id="staff-chat-input" type="text" class="form-control"
                 placeholder="Type your question and press Enter..."
                 autocomplete="off">
          <button class="btn btn-primary" type="submit">Send</button>
        </div>
        <small class="text-muted d-block mt-1">
          Examples: “What are the CSE departments?”, “How to check student attendance?”.
        </small>
      </form>
    </div>
  </div>
</div>

<script>
  const staffChatForm = document.getElementById("staff-chat-form");
  const staffChatInput = document.getElementById("staff-chat-input");
  const staffChatMessages = document.getElementById("staff-chat-messages");

  staffChatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = staffChatInput.value.trim();
    if (!text) return;

    // user bubble
    staffChatMessages.insertAdjacentHTML(
      "beforeend",
      `<div class="d-flex justify-content-end mb-2">
         <div class="p-2 rounded-3 bg-primary text-white" style="max-width:85%;">
           ${text}
         </div>
         <div class="badge bg-light text-muted ms-2">You</div>
       </div>`
    );
    staffChatInput.value = "";
    staffChatMessages.scrollTop = staffChatMessages.scrollHeight;

    try {
      const resp = await fetch("/api/assistant/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: text})
      });
      const data = await resp.json();
      const reply = data.reply || "Sorry, I could not understand that.";
      // assistant bubble
      staffChatMessages.insertAdjacentHTML(
        "beforeend",
        `<div class="d-flex mb-2">
           <div class="badge bg-primary me-2">Assistant</div>
           <div class="p-2 rounded-3 bg-white border" style="max-width:85%;">
             ${reply}
           </div>
         </div>`
      );
      staffChatMessages.scrollTop = staffChatMessages.scrollHeight;
    } catch (err) {
      staffChatMessages.insertAdjacentHTML(
        "beforeend",
        `<div class="d-flex mb-2">
           <div class="badge bg-primary me-2">Assistant</div>
           <div class="p-2 rounded-3 bg-white border text-danger" style="max-width:85%;">
             There was an error talking to the server.
           </div>
         </div>`
      );
      staffChatMessages.scrollTop = staffChatMessages.scrollHeight;
    }
  });
</script>
{% endblock %}
